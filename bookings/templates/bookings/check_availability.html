{% extends 'base.html' %}
{% load static %}

{% block title %}Check Room Availability - Daimaescape{% endblock %}

{% block content %}

<!-- Page Header Start -->
<div class="container-fluid page-header mb-5 p-0" style="background-image: url({% static 'img/carousel-01.jpg' %});">
  <div class="container-fluid page-header-inner py-5">
    <div class="container text-center pb-5">
      <h1 class="display-3 text-white mb-3 animated slideInDown">Check Availability</h1>
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb justify-content-center text-uppercase">
          <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
          <li class="breadcrumb-item"><a href="{% url 'rooms:room_list' %}">Rooms</a></li>
          <li class="breadcrumb-item text-white active" aria-current="page">Availability</li>
        </ol>
      </nav>
    </div>
  </div>
</div>
<!-- Page Header End -->

<!-- Availability Search Start -->
<div class="container-xxl py-5">
  <div class="container">
    <!-- Search Form (styled like booking form) -->
    <div class="bg-white shadow rounded p-4 mb-5">
      <form id="availability-form" class="row g-3 align-items-end">
        {% csrf_token %}
        <div class="col-md-3">
          <label class="form-label fw-bold">Check In</label>
          <input type="date" name="check_in" id="check_in" class="form-control" required min="{{ today|date:'Y-m-d' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label fw-bold">Check Out</label>
          <input type="date" name="check_out" id="check_out" class="form-control" required
            min="{{ tomorrow|date:'Y-m-d' }}">
        </div>
        <div class="col-md-2">
          <label class="form-label fw-bold">Adults</label>
          <input type="number" name="adults" id="adults" class="form-control" value="2" min="1" max="10">
        </div>
        <div class="col-md-2">
          <label class="form-label fw-bold">&nbsp;</label>
          <button type="submit" class="btn btn-primary w-100 py-2">Check Availability</button>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-bold">&nbsp;</label>
          <button type="button" id="reset-btn" class="btn btn-outline-secondary w-100 py-2">Reset</button>
        </div>
      </form>
    </div>

    <!-- Loading spinner -->
    <div id="loading" class="text-center my-5" style="display: none;">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Results container -->
    <div id="results-container">
      <!-- Initial message or results will be injected here -->
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('availability-form');
    const checkIn = document.getElementById('check_in');
    const checkOut = document.getElementById('check_out');
    const adults = document.getElementById('adults');
    const loading = document.getElementById('loading');
    const resultsContainer = document.getElementById('results-container');

    // Set min dates dynamically
    const today = new Date().toISOString().split('T')[0];
    checkIn.setAttribute('min', today);
    checkOut.setAttribute('min', today);

    // Ensure check-out is after check-in
    checkIn.addEventListener('change', function () {
      checkOut.min = this.value;
      if (checkOut.value && checkOut.value <= this.value) {
        checkOut.value = '';
      }
    });

    form.addEventListener('submit', function (e) {
      e.preventDefault();

      // Basic validation
      if (!checkIn.value || !checkOut.value) {
        alert('Please select both check-in and check-out dates.');
        return;
      }
      if (checkOut.value <= checkIn.value) {
        alert('Check-out date must be after check-in date.');
        return;
      }

      // Show loading
      loading.style.display = 'block';
      resultsContainer.innerHTML = '';

      // Build URL with query parameters
      const params = new URLSearchParams({
        check_in: checkIn.value,
        check_out: checkOut.value,
        adults: adults.value
      });

      fetch(`{% url 'booking:check_availability' %}?${params.toString()}`, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(response => response.json())
        .then(data => {
          loading.style.display = 'none';
          displayRooms(data.rooms);
        })
        .catch(error => {
          loading.style.display = 'none';
          resultsContainer.innerHTML = '<div class="alert alert-danger">An error occurred. Please try again.</div>';
          console.error('Error:', error);
        });
    });

    function displayRooms(rooms) {
      if (!rooms || rooms.length === 0) {
        resultsContainer.innerHTML = `
                <div class="text-center py-5">
                    <i class="fa fa-bed fa-3x text-muted mb-3"></i>
                    <h4>No rooms available</h4>
                    <p class="text-muted">Try different dates or check back later.</p>
                </div>
            `;
        return;
      }

      let html = `
            <div class="row g-4">
                <div class="col-12">
                    <h4 class="mb-4">Available Rooms (${rooms.length})</h4>
                </div>
        `;

      rooms.forEach(room => {
        html += `
                <div class="col-lg-4 col-md-6">
                    <div class="room-item shadow rounded overflow-hidden">
                        <div class="position-relative">
                            <img class="img-fluid" src="${room.image || '{% static "img/room-default.jpg" %}'}" alt="${room.name}" style="width: 100%; height: 200px; object-fit: cover;">
                            <small class="position-absolute start-0 top-100 translate-middle-y bg-primary text-white rounded py-1 px-3 ms-4">$${room.price}/Night</small>
                        </div>
                        <div class="p-3">
                            <h5 class="mb-2">${room.name}</h5>
                            <p class="text-body mb-2">Max guests: ${room.max_guests}</p>
                            <div class="d-flex justify-content-between">
                                <a href="/rooms/room/${room.slug}/" class="btn btn-sm btn-primary">View Details</a>
                                <a href="{% url 'booking:booking' %}?room=${room.slug}&check_in=${checkIn.value}&check_out=${checkOut.value}&adults=${adults.value}" class="btn btn-sm btn-dark">Book Now</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
      });

      html += '</div>';
      resultsContainer.innerHTML = html;
    }

    // Reset form
    document.getElementById('reset-btn').addEventListener('click', function () {
      form.reset();
      resultsContainer.innerHTML = '';
    });
  });
</script>
{% endblock %}
